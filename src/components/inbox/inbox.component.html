
<div class="h-[calc(100vh-10rem)] flex flex-col">
  <!-- Header -->
  <header class="pb-6 border-b border-border dark:border-slate-700">
    <h1 class="text-3xl font-bold text-text-primary dark:text-slate-100">Inbox</h1>
    <p class="mt-1 text-sm text-text-secondary dark:text-slate-400">All new leads, one place. No lead left behind.</p>
    <div class="mt-4 flex items-center space-x-2">
       <button (click)="activeFilter.set('all')" [class]="activeFilter() === 'all' ? 'bg-primary text-white' : 'bg-card dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'" class="px-3 py-1 text-sm font-semibold border border-slate-300 dark:border-slate-600 rounded-full">All</button>
       <button (click)="activeFilter.set('needs_reply')" [class]="activeFilter() === 'needs_reply' ? 'bg-primary text-white' : 'bg-card dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'" class="px-3 py-1 text-sm font-semibold border border-slate-300 dark:border-slate-600 rounded-full">Needs First Reply</button>
       <button (click)="activeFilter.set('hot')" [class]="activeFilter() === 'hot' ? 'bg-primary text-white' : 'bg-card dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'" class="px-3 py-1 text-sm font-semibold border border-slate-300 dark:border-slate-600 rounded-full">Hot ðŸ”¥</button>
       <button (click)="activeFilter.set('disqualified')" [class]="activeFilter() === 'disqualified' ? 'bg-primary text-white' : 'bg-card dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'" class="px-3 py-1 text-sm font-semibold border border-slate-300 dark:border-slate-600 rounded-full">Disqualified</button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="flex-1 flex min-h-0 bg-card dark:bg-slate-800 rounded-b-lg border border-t-0 border-border dark:border-slate-700">
    <!-- A) Left panel: Lead Feed -->
    <aside class="w-1/3 border-r border-border dark:border-slate-700 overflow-y-auto">
      @if (filteredLeads().length > 0) {
        <ul>
          @for (lead of filteredLeads(); track lead.id) {
            <li (click)="selectLead(lead)" class="p-4 border-b border-border dark:border-slate-700 cursor-pointer" [class]="selectedLead()?.id === lead.id ? 'bg-primary-light dark:bg-slate-700' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'">
              <div class="flex justify-between items-start">
                <p class="font-bold text-text-primary dark:text-slate-200">{{ lead.name }}</p>
                @if(lead.unread) { <span class="h-2.5 w-2.5 bg-primary rounded-full"></span> }
              </div>
              <p class="text-sm text-text-secondary dark:text-slate-400">{{ lead.origin }} &middot; {{ getTimeSince(lead.createdAt) }}</p>
              @if(lead.sla && !lead.contacted) {
                <div class="mt-2 text-xs font-semibold px-2 py-1 rounded" [class]="getSLATime(lead.sla.firstResponseDue).urgent ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'">
                  {{ getSLATime(lead.sla.firstResponseDue).text }}
                </div>
              }
              @if(lead.priority) {
                 <div class="mt-2 text-xs font-semibold px-2 py-1 rounded inline-block" [class]="{'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300': lead.priority === 'Hot', 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300': lead.priority === 'Warm', 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300': lead.priority === 'Cold'}">
                  {{ lead.priority }}
                </div>
              }
            </li>
          }
        </ul>
      } @else {
        <div class="p-8 text-center text-text-secondary dark:text-slate-400">
          <p class="font-medium">Inbox clear!</p>
          <p class="text-sm">No leads match the current filter.</p>
        </div>
      }
    </aside>

    <!-- B) Center panel: Lead Details -->
    <main class="flex-1 overflow-y-auto p-6">
      @if (selectedLead(); as lead) {
        <div>
          <h2 class="text-2xl font-bold text-text-primary dark:text-slate-100">{{ lead.name }}</h2>
          <p class="text-sm text-text-secondary dark:text-slate-400">from {{ lead.origin }}</p>
          
          <div class="mt-6 border-t border-border dark:border-slate-700 pt-6">
            <h3 class="text-lg font-semibold text-text-primary dark:text-slate-200">Conversation</h3>
             @if (lead.messages.length > 0) {
              <div class="mt-2 space-y-3 text-sm">
                @for(message of lead.messages; track message.timestamp) {
                  <div class="p-3 rounded-lg max-w-md" [class]="message.sender === 'user' ? 'ml-auto bg-primary text-primary-foreground' : 'mr-auto bg-slate-100 dark:bg-slate-700 text-text-primary dark:text-slate-200'">
                    {{ message.content }}
                  </div>
                }
              </div>
            } @else {
              <p class="mt-2 text-sm text-text-secondary dark:text-slate-400 italic">No messages yet.</p>
            }
          </div>

          @if(lead.qualification) {
            <div class="mt-6 border-t border-border dark:border-slate-700 pt-6">
               <h3 class="text-lg font-semibold text-text-primary dark:text-slate-200">Qualification Summary</h3>
               <div class="mt-2 grid grid-cols-2 gap-4 text-sm text-text-primary dark:text-slate-300">
                  <div><span class="font-semibold text-text-secondary dark:text-slate-400">Budget:</span> {{lead.qualification.budget}}</div>
                  <div><span class="font-semibold text-text-secondary dark:text-slate-400">Urgency:</span> {{lead.qualification.urgency}}</div>
                  <div><span class="font-semibold text-text-secondary dark:text-slate-400">Fit:</span> {{lead.qualification.fit}}</div>
                  <div><span class="font-semibold text-text-secondary dark:text-slate-400">Intent:</span> {{lead.qualification.intent}}</div>
               </div>
            </div>
          }
        </div>
      } @else {
        <div class="h-full flex items-center justify-center text-text-secondary dark:text-slate-500">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
            <h3 class="mt-2 text-sm font-medium text-text-primary dark:text-slate-300">Select a lead</h3>
            <p class="mt-1 text-sm text-text-secondary dark:text-slate-400">Choose a lead from the list to see details.</p>
          </div>
        </div>
      }
    </main>

    <!-- C) Right panel: Quick Actions -->
    <aside class="w-1/4 border-l border-border dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-6">
      @if (selectedLead(); as lead) {
         <div>
          <h3 class="font-bold text-text-primary dark:text-slate-200">Quick Actions</h3>
          <div class="mt-4 space-y-3">
             <button class="w-full text-left p-3 rounded-md bg-primary text-primary-foreground font-semibold hover:bg-primary-hover">Reply Now</button>
             <button (click)="showQualificationModal.set(true)" [disabled]="lead.status === 'Qualified' || lead.status === 'Disqualified'" class="w-full text-left p-3 rounded-md bg-card dark:bg-slate-700 border border-border dark:border-slate-600 text-text-primary dark:text-slate-200 font-semibold hover:bg-slate-50 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed">Qualify Lead</button>
             <button class="w-full text-left p-3 rounded-md bg-card dark:bg-slate-700 border border-border dark:border-slate-600 text-text-primary dark:text-slate-200 font-semibold hover:bg-slate-50 dark:hover:bg-slate-600">Schedule Follow-up</button>
             <button class="w-full text-left p-3 rounded-md bg-card dark:bg-slate-700 border border-border dark:border-slate-600 text-text-primary dark:text-slate-200 font-semibold hover:bg-slate-50 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed" [disabled]="lead.status !== 'Qualified'">Create Deal</button>
             <button class="w-full text-left p-3 rounded-md font-semibold text-danger dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30">Disqualify</button>
          </div>
           @if(lead.score) {
            <div class="mt-6 border-t border-border dark:border-slate-700 pt-4">
              <h4 class="font-bold text-text-primary dark:text-slate-200">Lead Score</h4>
              <p class="text-4xl font-bold mt-1" [class]="{'text-warning': lead.priority === 'Hot', 'text-yellow-500': lead.priority === 'Warm', 'text-text-secondary dark:text-slate-400': lead.priority === 'Cold'}">{{lead.score}} <span class="text-lg">/ 100</span></p>
            </div>
          }
         </div>
      } @else {
        <div class="text-center text-text-secondary dark:text-slate-400 text-sm">
            <p>Actions will appear here when you select a lead.</p>
        </div>
      }
    </aside>
  </div>
</div>

@if(showQualificationModal() && selectedLead()) {
  <app-qualification-modal 
    [leadName]="selectedLead()!.name"
    (close)="showQualificationModal.set(false)"
    (save)="handleQualify($event)">
  </app-qualification-modal>
}
