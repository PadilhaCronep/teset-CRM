
<div class="space-y-6">
  <!-- Header with Totals & Manager View Toggle -->
  <div class="flex flex-col sm:flex-row justify-between sm:items-center">
    <div>
      <h1 class="text-3xl font-bold text-text-primary dark:text-slate-100">{{ 'Pipeline' }}</h1>
      <div class="mt-1 flex items-center space-x-4 text-sm text-text-secondary dark:text-slate-400">
        <span>Total: <b class="text-text-primary dark:text-slate-200">${{ totalPipelineValue().toLocaleString() }}</b></span>
        <span>Expected: <b class="text-green-600 dark:text-green-400">${{ expectedRevenue().toLocaleString() }}</b></span>
        @if(gapToGoal() > 0) {
          <span>Gap: <b class="text-amber-600 dark:text-amber-400">${{ gapToGoal().toLocaleString() }}</b></span>
        }
      </div>
    </div>
    <div class="mt-4 sm:mt-0 flex items-center space-x-3">
      <label for="manager-view" class="text-sm font-medium text-text-secondary dark:text-slate-400">Manager View</label>
      <div class="w-10 h-6 flex items-center rounded-full cursor-pointer" [class]="isManagerView() ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-600'" (click)="isManagerView.set(!isManagerView())">
        <div class="h-4 w-4 rounded-full bg-white transform transition-transform" [class.translate-x-4]="isManagerView()"></div>
      </div>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="w-full overflow-x-auto pb-4 kanban-container -mx-4 px-4" (dragleave)="onBoardDragLeave()">
    <div class="flex space-x-4 min-w-max">
      @for(stage of stages; track stage) {
        <div (dragover)="onDragOver($event, stage)" (drop)="onDrop($event, stage)" 
             class="w-80 bg-slate-100 dark:bg-slate-900/50 rounded-xl flex-shrink-0 flex flex-col transition-colors duration-200"
             [class.bg-primary-light/40]="dragOverStage() === stage"
             [class.dark:bg-slate-800]="dragOverStage() === stage">
          <!-- Column Header -->
          <div class="p-4 border-b border-slate-200 dark:border-slate-700/50 flex justify-between items-center">
            <h2 class="font-semibold text-slate-700 dark:text-slate-300 flex items-center">
              {{ stage }} 
              <span class="ml-2 text-sm font-medium text-slate-500 dark:text-slate-400 bg-slate-200 dark:bg-slate-700 rounded-full px-2 py-0.5">{{ dealsInStage()(stage).length }}</span>
              @if(managerStats().bottleneckStage === stage && isManagerView()) {
                <span class="ml-2 text-xs font-bold text-amber-800 dark:text-amber-300 bg-amber-100 dark:bg-amber-900/30 px-2 py-0.5 rounded-full">Bottleneck</span>
              }
            </h2>
            <span class="text-sm font-bold text-slate-600 dark:text-slate-200">${{ stageValue()(stage).toLocaleString() }}</span>
          </div>
          <!-- Manager Stats -->
          @if(isManagerView() && managerStats().stats[stage]; as stats) {
            <div class="p-2 text-xs grid grid-cols-3 gap-1 text-center bg-slate-200 dark:bg-slate-800/50">
              <div><b class="dark:text-white">{{ stats.avgAge.toFixed(1) }}d</b> <span class="text-slate-500 dark:text-slate-400">avg. age</span></div>
              <div><b class="text-amber-600 dark:text-amber-400">{{ stats.stalled }}</b> <span class="text-slate-500 dark:text-slate-400">stalled</span></div>
              <div><b class="text-red-600 dark:text-red-400">{{ stats.overdue }}</b> <span class="text-slate-500 dark:text-slate-400">overdue</span></div>
            </div>
          }
          <!-- Cards Container -->
          <div class="p-2 space-y-2 h-full overflow-y-auto flex-1">
            @for(deal of dealsInStage()(stage); track deal.id) {
              <div draggable="true" 
                   (dragstart)="onDragStart(deal)"
                   (dragend)="onDragEnd()"
                   class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-3 cursor-pointer group transition-all duration-200"
                   [class]="{
                    'border-l-4 border-red-500': deal.riskStatus === 'overdue',
                    'border-l-4 border-amber-500': deal.riskStatus === 'due-today',
                    'border-l-4 border-green-500': deal.riskStatus === 'on-track',
                    'border-l-4 border-slate-400': deal.riskStatus === 'needs-scheduling',
                    'opacity-60 grayscale-[50%]': deal.specialStatus === 'Paused',
                    'opacity-40 rotate-1': draggedDeal()?.id === deal.id
                   }">
                <!-- Card Header -->
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-slate-800 dark:text-slate-100 leading-tight flex items-center">
                      @if(deal.riskStatus === 'overdue') {
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 text-red-500 mr-1.5" [attr.title]="'Overdue by ' + deal.overdueDays + ' days'"><path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14ZM9 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM7 7a1 1 0 0 1 1-1h.008a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0V7Z" clip-rule="evenodd" /></svg>
                      }
                      {{ deal.lead.name }}
                    </p>
                    @if (deal.owner) {
                      <img [src]="deal.owner.avatar" [alt]="deal.owner.name" class="h-6 w-6 rounded-full ring-2 ring-white dark:ring-slate-800">
                    }
                </div>
                <p class="text-sm font-medium text-slate-600 dark:text-slate-300 mt-1">${{ deal.value.toLocaleString() }}</p>

                <!-- Tags: Stalled, Stagnation, Special Status -->
                <div class="mt-2 flex items-center space-x-2">
                   @if(deal.isStalled) {
                     <span class="inline-flex items-center text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300">Stalled</span>
                   }
                   <span class="text-xs text-slate-400 dark:text-slate-500">{{deal.daysInStage}}d in stage</span>
                   @if(deal.specialStatus) {
                     <span class="inline-flex items-center text-xs font-semibold px-2 py-0.5 rounded-full bg-sky-100 text-sky-800 dark:bg-sky-900/50 dark:text-sky-300">{{deal.specialStatus}}</span>
                   }
                </div>

                <!-- Executable Next Action -->
                <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700 space-y-2">
                  <div class="flex items-center space-x-2">
                    <button (click)="handleCompleteAction($event, deal.lead)" class="h-5 w-5 rounded-full border-2 flex-shrink-0" [class]="deal.lead.actionCompleted ? 'bg-primary border-primary' : 'border-slate-400 dark:border-slate-500 hover:border-primary'">
                      @if(deal.lead.actionCompleted) {
                        <svg class="h-full w-full text-white" viewBox="0 0 16 16" fill="currentColor"><path d="M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z"/></svg>
                      }
                    </button>
                    <span class="text-sm text-slate-700 dark:text-slate-300" [class]="{'line-through text-slate-400 dark:text-slate-500': deal.lead.actionCompleted}">{{ deal.lead.nextActionText }}</span>
                  </div>
                  <div class="flex items-center justify-between text-xs">
                    <span class="font-medium" [class]="{
                      'text-red-600 dark:text-red-400': deal.riskStatus === 'overdue',
                      'text-amber-600 dark:text-amber-400': deal.riskStatus === 'due-today',
                      'text-slate-500 dark:text-slate-400': deal.riskStatus !== 'overdue' && deal.riskStatus !== 'due-today'
                    }">
                      @if(deal.lead.dueDate) { Due: {{ deal.lead.dueDate | date:'MMM d' }} } @else { Needs scheduling }
                    </span>
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center space-x-2">
                        <label class="cursor-pointer text-slate-500 hover:text-primary dark:hover:text-indigo-400" title="Reschedule">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 0 1 .75.75V3h6.5V2.5a.75.75 0 0 1 1.5 0V3h.25A2.75 2.75 0 0 1 15.5 5.75v7.5A2.75 2.75 0 0 1 12.75 16H3.25A2.75 2.75 0 0 1 .5 13.25v-7.5A2.75 2.75 0 0 1 3.25 3H3.5V2.5a.75.75 0 0 1 .75-.75Zm-2 4A1.25 1.25 0 0 1 3.25 4.5h9.5A1.25 1.25 0 0 1 14 5.75v1.285A.75.75 0 0 1 13.25 7.8H2.75a.75.75 0 0 1-.75-.765V5.75Z" clip-rule="evenodd" /></svg>
                            <input type="date" class="sr-only" [ngModel]="deal.lead.dueDate | date:'yyyy-MM-dd'" (change)="handleReschedule($event, deal.lead)">
                        </label>
                        <button (click)="openDetailSlideover(deal)" class="text-slate-500 hover:text-primary dark:hover:text-indigo-400" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L3 10.536l-1.06 3.182a.75.75 0 0 0 .94.94L6.064 13l8.025-8.024a1.75 1.75 0 0 0 0-2.476Z M5.201 11.5l-2.12 2.12 1.06-3.181 1.06 1.06ZM12.25 4.187l-1.06-1.06 1.06-1.06a.25.25 0 0 1 .354 0l.707.707a.25.25 0 0 1 0 .354l-1.06 1.06Z" /></svg></button>
                    </div>
                  </div>
                </div>

                <!-- Hover Quick Actions -->
                <div class="absolute bottom-2 right-2 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <button (click)="openDetailSlideover(deal)" class="h-6 w-6 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600" title="Open details"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5a.75.75 0 0 0 1.5 0v-4.5ZM8 6.25a.75.75 0 0 0-1.5 0v3a.75.75 0 0 0 1.5 0v-3ZM5.25 7.75a.75.75 0 0 0-1.5 0v1.5a.75.75 0 0 0 1.5 0v-1.5Z" /><path fill-rule="evenodd" d="M2 2.75C2 1.784 2.784 1 3.75 1h8.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25V2.75ZM3.5 2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25h-8.5Z" clip-rule="evenodd" /></svg></button>
                  <button class="h-6 w-6 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600" title="Message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M1.5 2.75A1.75 1.75 0 0 1 3.25 1h9.5A1.75 1.75 0 0 1 14.5 2.75V9.5A1.75 1.75 0 0 1 12.75 11h-3.973l-2.074 1.838a.75.75 0 0 1-1.111-.69V11H3.25A1.75 1.75 0 0 1 1.5 9.25V2.75ZM3.25 2.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.389a.75.75 0 0 1 .75.75v1.258l1.36-1.206a.75.75 0 0 1 .451-.152H12.75a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25h-9.5Z" clip-rule="evenodd" /></svg></button>
                  <button (click)="openLucasModal(deal, 'card_hover')" class="h-6 w-6 flex items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/50 text-indigo-500 dark:text-indigo-400 hover:bg-indigo-200" title="Ask Lucas AI"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M10.03.99c.334.204.535.58.535.99v1.5c0 .41-.201.786-.535.99L5.34 8l4.69 3.53c.334.204.535.58.535.99v1.5c0 .41-.201.786-.535.99L2.84 13.52c-.52.316-1.2-.108-1.2-.72V3.2c0-.612.68-1.036 1.2-.72L10.03.99Z" /></svg></button>
                </div>
              </div>
            }
            @if(dealsInStage()(stage).length === 0) {
              <div class="p-4 text-center text-sm text-slate-400 dark:text-slate-500 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg h-24 flex flex-col justify-center">
                <h4 class="font-semibold text-slate-500 dark:text-slate-300">Drop deals here</h4>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Move Deal Modal -->
@if(showMoveModal() && modalContext(); as ctx) {
  <div class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50" (click)="closeMoveModal()">
    <div class="bg-card dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4" (click)="$event.stopPropagation()">
        <h2 class="text-xl font-bold text-text-primary dark:text-slate-100">Moving {{ctx.deal.lead.name}}</h2>
        <p class="text-sm text-text-secondary dark:text-slate-400 mt-1">From <b class="dark:text-white">{{ctx.deal.stage}}</b> to <b class="dark:text-white">{{ctx.targetStage}}</b>. A next action is required.</p>
      
        <div class="mt-6 space-y-4">
            <!-- Conditional Fields -->
            @if(ctx.targetStage === 'Won') {
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Final Value ($)</label>
                  <input type="number" [(ngModel)]="moveModal.finalValue" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                </div>
                 <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Payment Method</label>
                  <select [(ngModel)]="moveModal.paymentMethod" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                    <option>Stripe</option><option>Invoice</option><option>Pix</option>
                  </select>
                </div>
              </div>
            }
            @if(ctx.targetStage === 'Lost') {
                <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Loss Reason</label>
                  <select [(ngModel)]="moveModal.lossReason" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                    <option>Price</option><option>No Response</option><option>Competitor</option><option>No Fit</option><option>Other</option>
                  </select>
                </div>
            }
            @if(ctx.targetStage === 'Negotiation') {
                <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Main Objection</label>
                  <select [(ngModel)]="moveModal.objection" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                    <option>Price</option><option>Timing</option><option>Authority</option><option>Fit</option><option>Other</option>
                  </select>
                </div>
            }
             <!-- Standard Fields -->
            <div>
              <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Next Action</label>
              <input type="text" [(ngModel)]="moveModal.nextActionText" placeholder="e.g., Send welcome email" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
            </div>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Due Date</label>
                  <input type="date" [(ngModel)]="moveModal.dueDate" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                </div>
                <div>
                  <label class="block text-sm font-medium text-text-secondary dark:text-slate-300">Channel</label>
                  <select [(ngModel)]="moveModal.channel" class="mt-1 block w-full rounded-md border-border dark:border-slate-600 bg-card dark:bg-slate-700 text-text-primary dark:text-slate-200 shadow-sm sm:text-sm">
                    <option>WhatsApp</option><option>Call</option><option>Email</option>
                  </select>
                </div>
            </div>
             @if(moveModal.error) { <p class="text-sm text-red-500">{{moveModal.error}}</p> }
        </div>
        <div class="mt-8 flex justify-end space-x-3">
          <button type="button" (click)="closeMoveModal()" class="bg-card dark:bg-slate-700 py-2 px-4 border border-border dark:border-slate-600 rounded-md text-sm font-medium text-text-primary dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-600">Cancel</button>
          <button type="button" (click)="handleMoveDealSave()" class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-primary-foreground bg-primary hover:bg-primary-hover">Set Action & Move</button>
        </div>
    </div>
  </div>
}

<!-- Lucas AI Modal -->
@if(showLucasModal() && lucasContext(); as ctx) {
    <div class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50" (click)="showLucasModal.set(false)">
        <div class="bg-card dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4" (click)="$event.stopPropagation()">
            <h2 class="text-xl font-bold text-text-primary dark:text-slate-100 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5 mr-2 text-indigo-400"><path d="M10.03.99c.334.204.535.58.535.99v1.5c0 .41-.201.786-.535.99L5.34 8l4.69 3.53c.334.204.535.58.535.99v1.5c0 .41-.201.786-.535.99L2.84 13.52c-.52.316-1.2-.108-1.2-.72V3.2c0-.612.68-1.036 1.2-.72L10.03.99Z" /></svg> Ask Lucas AI</h2>
            <p class="text-sm text-text-secondary dark:text-slate-400 mt-1">Recommended next steps for <b>{{ctx.deal.lead.name}}</b> in <b>{{ctx.deal.stage}}</b> stage.</p>
            <div class="mt-4 space-y-3">
                @if(lucasIsThinking()) {
                    <div class="p-4 text-center text-text-secondary dark:text-slate-400">Lucas is thinking...</div>
                } @else {
                    @for(response of lucasResponse(); track response) {
                        <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                            <p class="text-sm text-text-primary dark:text-slate-200">{{response}}</p>
                            <button (click)="copyLucasResponse(response)" class="text-xs font-bold text-primary dark:text-indigo-400 hover:underline mt-2">Copy message</button>
                        </div>
                    }
                }
            </div>
             <div class="mt-6 text-right">
                <button (click)="showLucasModal.set(false)" class="bg-card dark:bg-slate-700 py-2 px-4 border border-border dark:border-slate-600 rounded-md text-sm font-medium text-text-primary dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-600">Close</button>
             </div>
        </div>
    </div>
}
